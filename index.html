<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>ç·Šæ€¥é€šå ±ç³»çµ±åŸå‹</title>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        :root {
            --sos-red: #e63946;
            --sos-dark: #b92b2b;
            --sos-green: #2a9d8f;
            --bg-color: #f1faee;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* é˜²æ­¢æ»¾å‹• */
        }

        /* --- æ¨¡æ“¬åœ°åœ–èƒŒæ™¯ --- */
        .map-placeholder {
            flex: 1;
            background-image: radial-gradient(#d1d1d1 1px, transparent 1px);
            background-size: 20px 20px;
            background-color: #e9ecef;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #adb5bd;
            font-size: 2rem;
            font-weight: bold;
            z-index: 1;
        }

        /* --- é–‹ç™¼è€…é™¤éŒ¯é¢æ¿ (å¯¦éš›ç”¢å“å¯éš±è—) --- */
        #debug-console {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            border-radius: 8px;
            height: 150px;
            overflow-y: auto;
            z-index: 2;
            pointer-events: none; /* è®“é»æ“Šç©¿é€ */
        }

        /* --- åº•éƒ¨å›ºå®š SOS å®¹å™¨ --- */
        .sos-container {
            position: fixed;
            bottom: 40px;
            left: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            pointer-events: none; /* å®¹å™¨ä¸æ“‹äº’å‹•ï¼Œåªæœ‰æŒ‰éˆ•æ“‹ */
        }

        /* --- æŒ‰éˆ•æœ¬é«” --- */
        .sos-btn {
            pointer-events: auto;
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--sos-red);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(230, 57, 70, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            transition: transform 0.1s;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        /* æŒ‰ä¸‹æ™‚çš„è¼•å¾®ç¸®æ”¾ */
        .sos-btn:active {
            transform: scale(0.95);
        }

        /* --- å…§éƒ¨åœ–ç¤ºèˆ‡æ–‡å­— --- */
        .sos-btn .icon {
            font-size: 28px;
            margin-bottom: 2px;
            z-index: 3;
            line-height: 1;
        }

        .sos-btn .label {
            font-size: 11px;
            font-weight: bold;
            z-index: 3;
        }

        /* --- é›†æ°£å‹•ç•«å±¤ (ç´…è‰²æ·±è‰²èƒŒæ™¯) --- */
        .sos-btn::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120%; /* ç¢ºä¿è¦†è“‹ */
            height: 120%;
            background-color: var(--sos-dark);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0); /* å¾ä¸­å¿ƒé–‹å§‹ */
            opacity: 1;
            transition: transform 0s;
            z-index: 1;
        }

        /* è§¸ç™¼é›†æ°£å‹•ç•« */
        .sos-btn.pressing::after {
            transform: translate(-50%, -50%) scale(1);
            transition: transform 1.5s linear; /* 1.5ç§’é›†æ°£æ™‚é–“ */
        }

        /* æˆåŠŸç‹€æ…‹ */
        .sos-btn.activated {
            background-color: var(--sos-green);
            box-shadow: 0 4px 15px rgba(42, 157, 143, 0.5);
        }
        
        .sos-btn.activated::after {
            opacity: 0; /* éš±è—é›†æ°£å±¤ */
        }

        /* --- æç¤ºæ–‡å­— --- */
        .hint-text {
            margin-top: 12px;
            font-size: 13px;
            color: #333;
            background-color: rgba(255,255,255,0.9);
            padding: 6px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-weight: 500;
            transition: opacity 0.3s;
        }

        /* éš±è—æç¤ºæ–‡å­—çš„ class */
        .fade-out {
            opacity: 0;
        }

    </style>
</head>
<body>

    <div class="map-placeholder">
        MAP VIEW
    </div>

    <div id="debug-console">ç³»çµ±æº–å‚™å°±ç·’...<br></div>

    <div class="sos-container">
        <button id="sos-btn" class="sos-btn" aria-label="ç·Šæ€¥é€šå ±æŒ‰éˆ•">
            <div class="icon">ğŸ†˜</div>
            <span class="label">é•·æŒ‰æ±‚æ•‘</span>
        </button>
        <div id="hint-text" class="hint-text">é•·æŒ‰ 1.5 ç§’å•Ÿå‹•é€šå ±</div>
    </div>

    <script>
        /**
         * è¨­å®šå€
         */
        const CONFIG = {
            EMERGENCY_PHONE: "0912345678", // æ›¿æ›ç‚ºå¯¦éš›ç·Šæ€¥é›»è©±
            API_ENDPOINT: "/api/emergency/log", // å¾Œç«¯æ¥æ”¶ API
            PRESS_DURATION: 1500, // é•·æŒ‰æ‰€éœ€æ™‚é–“ (æ¯«ç§’)
            GPS_TIMEOUT: 2000     // å®šä½æœ€é•·ç­‰å¾…æ™‚é–“ï¼Œè¶…éå‰‡å¼·åˆ¶æ’¥è™Ÿ
        };

        /**
         * è®Šæ•¸åˆå§‹åŒ–
         */
        const sosBtn = document.getElementById('sos-btn');
        const label = sosBtn.querySelector('.label');
        const hintText = document.getElementById('hint-text');
        const debugConsole = document.getElementById('debug-console');
        
        let pressTimer = null;
        let isActivated = false; // é¿å…é‡è¤‡è§¸ç™¼

        /**
         * è¼”åŠ©å‡½å¼ï¼šå¯«å…¥é™¤éŒ¯è¨Šæ¯
         */
        function log(msg) {
            const time = new Date().toLocaleTimeString();
            debugConsole.innerHTML += `[${time}] ${msg}<br>`;
            debugConsole.scrollTop = debugConsole.scrollHeight;
            console.log(msg);
        }

        /**
         * 1. ä½¿ç”¨è€…äº’å‹•è™•ç† (é•·æŒ‰é‚è¼¯)
         */
        function startPress(e) {
            // é˜²æ­¢å³éµé¸å–®æˆ–æ‰‹æ©Ÿé•·æŒ‰é¸å–
            if(e.type === "touchstart") {
                // e.preventDefault(); // æ³¨æ„ï¼šå¦‚æœéœ€è¦é é¢æ»¾å‹•ï¼Œé€™è£¡è¦å°å¿ƒä½¿ç”¨
            }
            
            if (isActivated) return;

            log("åµæ¸¬åˆ°æŒ‰å£“...");
            sosBtn.classList.add('pressing');
            label.innerText = "é€šå ±ä¸­...";
            hintText.classList.add('fade-out'); // éš±è—æç¤ºï¼Œæ¸›å°‘å¹²æ“¾

            // è¨­å®šè¨ˆæ™‚å™¨
            pressTimer = setTimeout(() => {
                triggerEmergencyProcedure();
            }, CONFIG.PRESS_DURATION);
        }

        function cancelPress() {
            if (isActivated) return;

            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }

            // åªæœ‰åœ¨é‚„æ²’è™•æ–¼"æŒ‰å£“ä¸­"ç‹€æ…‹æ‰ä¸éœ€è¦ logï¼Œé¿å…é›œè¨Š
            if (sosBtn.classList.contains('pressing')) {
                log("æŒ‰å£“å–æ¶ˆ");
                sosBtn.classList.remove('pressing');
                label.innerText = "é•·æŒ‰æ±‚æ•‘";
                hintText.classList.remove('fade-out');
            }
        }

        /**
         * 2. ç·Šæ€¥ç¨‹åºæ ¸å¿ƒé‚è¼¯
         */
        function triggerEmergencyProcedure() {
            isActivated = true;
            clearTimeout(pressTimer); // æ¸…é™¤é•·æŒ‰è¨ˆæ™‚
            
            // UI æ›´æ–°
            sosBtn.classList.remove('pressing');
            sosBtn.classList.add('activated');
            label.innerText = "å·²å•Ÿå‹•";
            hintText.innerHTML = "æ­£åœ¨å®šä½ä¸¦æ’¥è™Ÿ...";
            hintText.classList.remove('fade-out');

            // è§¸è¦ºå›é¥‹ (æ‰‹æ©Ÿéœ‡å‹•)
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200, 100, 500]);
            }

            log("ğŸ”¥ ç·Šæ€¥ç¨‹åºå•Ÿå‹•ï¼");

            // --- ä¸¦è¡Œè™•ç†ï¼šè¨­å®šä¸€å€‹å¼·åˆ¶æ’¥è™Ÿçš„ä¿éšªçµ² ---
            let callHasBeenTriggered = false;

            const triggerCall = (source) => {
                if (!callHasBeenTriggered) {
                    callHasBeenTriggered = true;
                    log(`ğŸ“ æ­£åœ¨æ’¥æ‰“é›»è©± (è§¸ç™¼æº: ${source})`);
                    
                    // é€™è£¡åŸ·è¡Œæ’¥è™Ÿ
                    window.location.href = `tel:${CONFIG.EMERGENCY_PHONE}`;
                    
                    // æ’¥è™Ÿå¾Œç¨å¾®å»¶é²é‡ç½® UI (é¸ç”¨)
                    setTimeout(() => {
                        // alert("ç³»çµ±å·²å˜—è©¦æ’¥è™Ÿä¸¦å‚³é€ä½ç½®"); // æ¸¬è©¦ç”¨
                    }, 1000);
                }
            };

            // è¨­å®šå®‰å…¨è¨ˆæ™‚å™¨ (Safety Net)
            const safetyTimer = setTimeout(() => {
                log("âš ï¸ å®šä½è¶…æ™‚ï¼Œå¼·åˆ¶åŸ·è¡Œæ’¥è™Ÿ");
                triggerCall('Timeout Safety Net');
            }, CONFIG.GPS_TIMEOUT);

            // --- å˜—è©¦ç²å–ä½ç½® ---
            if (!navigator.geolocation) {
                log("âŒ ç€è¦½å™¨ä¸æ”¯æ´å®šä½");
                triggerCall('No Geolocation Support');
                return;
            }

            log("ğŸ“ æ­£åœ¨è«‹æ±‚é«˜ç²¾åº¦ä½ç½®...");
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // --- å®šä½æˆåŠŸ ---
                    clearTimeout(safetyTimer); // å–æ¶ˆå¼·åˆ¶æ’¥è™Ÿè¨ˆæ™‚å™¨ï¼Œæ”¹ç”±é€™è£¡è§¸ç™¼

                    const payload = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date().toISOString(),
                        alert_type: "SOS_BUTTON",
                        user_agent: navigator.userAgent
                    };

                    log(`âœ… å®šä½æˆåŠŸ: ${payload.lat.toFixed(5)}, ${payload.lng.toFixed(5)} (ç²¾åº¦: ${payload.accuracy}m)`);

                    // å‚³é€è³‡æ–™ (ä½¿ç”¨ Beacon API)
                    sendDataToBackend(payload);

                    // ç«‹å³æ’¥è™Ÿ
                    triggerCall('GPS Success');
                },
                (error) => {
                    // --- å®šä½å¤±æ•— ---
                    clearTimeout(safetyTimer); // å–æ¶ˆå¼·åˆ¶æ’¥è™Ÿè¨ˆæ™‚å™¨
                    
                    const errorMsg = `å®šä½éŒ¯èª¤ (Code ${error.code}): ${error.message}`;
                    log(`âŒ ${errorMsg}`);

                    // å˜—è©¦å‚³é€éŒ¯èª¤ç´€éŒ„
                    sendDataToBackend({ error: errorMsg, timestamp: new Date().toISOString() });

                    // å¤±æ•—ä»è¦æ’¥è™Ÿ
                    triggerCall('GPS Error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: CONFIG.GPS_TIMEOUT - 200, // æ¯”å®‰å…¨è¨ˆæ™‚å™¨ç¨å¾®çŸ­ä¸€é»
                    maximumAge: 0
                }
            );
        }

        /**
         * 3. è³‡æ–™å‚³é€ (Beacon API)
         */
        function sendDataToBackend(data) {
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            
            // å„ªå…ˆä½¿ç”¨ sendBeacon
            if (navigator.sendBeacon) {
                const success = navigator.sendBeacon(CONFIG.API_ENDPOINT, blob);
                log(`ğŸ“¡ è³‡æ–™ç™¼é€è«‹æ±‚ (Beacon): ${success ? 'å·²æ’ç¨‹' : 'å¤±æ•—'}`);
            } else {
                // Fallback: ä½¿ç”¨ fetch (åœ¨é é¢å³å°‡è·³è½‰æ™‚å¯èƒ½ä¸ç©©å®š)
                fetch(CONFIG.API_ENDPOINT, {
                    method: 'POST',
                    body: blob,
                    keepalive: true // é‡è¦ï¼šå˜—è©¦åœ¨é é¢é—œé–‰å¾Œä¿æŒé€£ç·š
                }).catch(err => log("Fetch Error: " + err));
            }
        }

        /**
         * äº‹ä»¶ç¶å®š
         */
        // æ»‘é¼ äº‹ä»¶ (é›»è…¦æ¸¬è©¦ç”¨)
        sosBtn.addEventListener('mousedown', startPress);
        sosBtn.addEventListener('mouseup', cancelPress);
        sosBtn.addEventListener('mouseleave', cancelPress);

        // è§¸æ§äº‹ä»¶ (æ‰‹æ©Ÿç”¨)
        sosBtn.addEventListener('touchstart', startPress);
        sosBtn.addEventListener('touchend', cancelPress);
        sosBtn.addEventListener('touchcancel', cancelPress);

    </script>
</body>
</html>